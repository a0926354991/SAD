import { GOOGLE_MAPS_MAP_ID } from './config.js';

let map;
let marker;
let nameLabel;
let currentStore = null;
let wheelStores = []; // Êñ∞Â¢ûÔºöÂÑ≤Â≠òËΩâÁõ§‰∏≠ÁöÑÂïÜÂ∫ó
let allStores = []; // Êñ∞Â¢ûÔºöÂÑ≤Â≠òÊâÄÊúâÊãâÈ∫µÂ∫óË≥áÊñô
let allMarkers = []; // Êñ∞Â¢ûÔºöÂÑ≤Â≠òÊâÄÊúâÊ®ôË®ò

// Êñ∞Â¢ûÔºöÁôªÂÖ•Áõ∏ÈóúËÆäÊï∏
let currentUser = null;

// Êñ∞Â¢ûÔºöËá™ÂÆöÁæ©‰∫ã‰ª∂Á≥ªÁµ±
const storeEvents = {
    listeners: {},
    on(event, callback) {
        if (!this.listeners[event]) {
            this.listeners[event] = [];
        }
        this.listeners[event].push(callback);
    },
    emit(event, data) {
        if (this.listeners[event]) {
            this.listeners[event].forEach(callback => callback(data));
        }
    }
};

// Êñ∞Â¢ûÔºöÊ™¢Êü•ÁôªÂÖ•ÁãÄÊÖã
async function checkLoginStatus() {
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get("user_id");
    
    if (userId) {
        try {
            const response = await fetch(`https://linebot-fastapi-uhmi.onrender.com/users/${userId}`);
            const data = await response.json();
            
            if (data.status === "success") {
                currentUser = data.user; // Â≠òÂÑ≤ÂÆåÊï¥ÁöÑÁî®Êà∂Ë≥áÊñô
                updateLoginUI();
            } else {
                console.error('User not found:', data.message);
            }
        } catch (error) {
            console.error('Error checking login status:', error);
        }
    }
}

// Êñ∞Â¢ûÔºöÊ∑ªÂä†Áî®Êà∂‰ΩçÁΩÆÊ®ôË®ò
function addUserLocationMarker(lat, lng) {
    // ÁßªÈô§ËàäÁöÑÁî®Êà∂‰ΩçÁΩÆÊ®ôË®òÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
    if (window.userLocationMarker) {
        window.userLocationMarker.setMap(null);
    }

    // ÂâµÂª∫Êñ∞ÁöÑÊ®ôË®ò
    const markerContent = document.createElement("div");
    markerContent.className = "marker-content user-location-marker";
    
    // Ê∑ªÂä†Áî®Êà∂‰ΩçÁΩÆÂúñÊ®ô
    const userIcon = document.createElement("img");
    userIcon.src = "./src/assets/images/user-location.png";
    userIcon.className = "user-marker-img user-location-icon";
    markerContent.appendChild(userIcon);

    // ÂâµÂª∫Ê®ôË®ò
    window.userLocationMarker = new google.maps.marker.AdvancedMarkerElement({
        map,
        position: { lat, lng },
        content: markerContent,
        title: "ÊÇ®ÁöÑ‰ΩçÁΩÆ",
        zIndex: 1000  // Á¢∫‰øùÁî®Êà∂‰ΩçÁΩÆÊ®ôË®òÂú®ÊúÄ‰∏äÂ±§
    });
}

// Êñ∞Â¢ûÔºöÊõ¥Êñ∞ÁôªÂÖ•UI
function updateLoginUI() {
    const loginButton = document.getElementById('loginButton');
    const userInfo = document.getElementById('userInfo');
    
    if (currentUser) {
        loginButton.style.display = 'none';
        userInfo.style.display = 'flex';
        userInfo.querySelector('.username').textContent = currentUser.display_name;
    } else {
        loginButton.style.display = 'flex';
        userInfo.style.display = 'none';
    }
}

// Êñ∞Â¢ûÔºöÈ°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØ
function showToast(message) {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    toast.style.zIndex = '9999'; // Á¢∫‰øùÈ°ØÁ§∫Âú®ÊúÄ‰∏äÂ±§
    toastContainer.appendChild(toast);

    // 3ÁßíÂæåÁßªÈô§ÊèêÁ§∫Ë®äÊÅØ
    setTimeout(() => {
        toast.remove();
    }, 1500);
}

// Êñ∞Â¢ûÔºöÊ™¢Êü•Â∫óÂÆ∂ÊòØÂê¶Âú®ËΩâÁõ§‰∏≠
function isStoreInWheel(store) {
    return wheelStores.some(wheelStore => 
        wheelStore.name === store.name && 
        wheelStore.address === store.address
    );
}

// Êñ∞Â¢ûÔºöÊõ¥Êñ∞Âä†ÂÖ•/ÁßªÈô§ÊåâÈàïÁöÑÂúñÁ§∫
function updateAddToWheelButton(store) {
    const addToWheelFab = document.getElementById('addToWheelFab');
    if (store && isStoreInWheel(store)) {
        addToWheelFab.innerHTML = '<i class="fas fa-minus"></i>';
    } else {
        addToWheelFab.innerHTML = '<i class="fas fa-plus"></i>';
    }
}

// Êñ∞Â¢ûÔºöÂç≥ÊôÇÊêúÂ∞ãÂäüËÉΩ
function searchStores(query, showToast = false, selectFirst = false, isQuickCheckIn = false) {
    const searchResults = allStores.filter(store => 
        store.name.toLowerCase().includes(query.toLowerCase()) ||
        store.address.toLowerCase().includes(query.toLowerCase()) ||
        (store.keywords && store.keywords.some(keyword => 
            keyword.toLowerCase().includes(query.toLowerCase())
        ))
    );

    const searchResultsList = isQuickCheckIn ? 
        document.getElementById('quickCheckInResults') : 
        document.getElementById('searchResults');
    
    searchResultsList.innerHTML = '';

    if (query.trim() === '') {
        searchResultsList.style.display = 'none';
        return;
    }

    if (searchResults.length > 0) {
        searchResults.forEach((store, index) => {
            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            resultItem.innerHTML = `
                <div class="store-name">${store.name}</div>
                <div class="store-address">${store.address}</div>
            `;
            resultItem.addEventListener('click', () => {
                if (isQuickCheckIn) {
                    selectStoreForQuickCheckIn(store);
                } else {
                    selectStore(store);
                }
                searchResultsList.style.display = 'none';
            });
            searchResultsList.appendChild(resultItem);

            // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÂÄãÁµêÊûú‰∏îÈúÄË¶ÅÈÅ∏‰∏≠ÔºåÂâáÈÅ∏‰∏≠ÂÆÉ
            if (index === 0 && selectFirst) {
                if (isQuickCheckIn) {
                    selectStoreForQuickCheckIn(store);
                } else {
                    selectStore(store);
                }
                searchResultsList.style.display = 'none';
            }
        });
        // Âè™ÊúâÂú®Âç≥ÊôÇÊêúÂ∞ãÊôÇÊâçÈ°ØÁ§∫ÁµêÊûúÂàóË°®
        if (!selectFirst) {
            searchResultsList.style.display = 'block';
        }
    } else {
        searchResultsList.style.display = 'none';
        // Áï∂ÈúÄË¶ÅÈ°ØÁ§∫ÊèêÁ§∫‰∏îÊ≤íÊúâÁµêÊûúÊôÇÔºåÈ°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØ
        if (showToast) {
            showToast('üò≠Êâæ‰∏çÂà∞Á¨¶ÂêàÁöÑÂ∫óÂÆ∂üò≠');
        }
    }
}

// Êñ∞Â¢ûÔºöÈÅ∏ÊìáÂ∫óÂÆ∂
function selectStore(store) {
    const position = {
        lat: store.location.latitude,
        lng: store.location.longitude
    };
    
    const newCenter = {
        lat: position.lat - 0.0015,
        lng: position.lng
    };
    
    map.panTo(newCenter);
    map.setZoom(16);

    renderStoreInfo(store);
    showCheckInButton(store);

    // ÊâæÂà∞Â∞çÊáâÁöÑÊ®ôË®ò‰∏¶Âè™È°ØÁ§∫ÂÆÉ
    const selectedMarker = allMarkers.find(marker => marker.store === store);
    if (selectedMarker) {
        showOnlySelectedMarker(selectedMarker);
    }
}

// Êñ∞Â¢ûÔºöÂø´ÈÄüÊâìÂç°Áõ∏ÈóúÁöÑ DOM ÂÖÉÁ¥†
const quickCheckInModal = document.getElementById('quickCheckInModal');
const quickCheckInSearch = document.getElementById('quickCheckInSearch');
const quickCheckInResults = document.getElementById('quickCheckInResults');
const quickCheckInForm = document.getElementById('quickCheckInForm');
const quickCheckInStoreInfo = document.querySelector('#quickCheckInModal .store-info');
const quickCheckInStoreName = document.getElementById('quickCheckInStoreName');
const quickCheckInStoreAddress = document.getElementById('quickCheckInStoreAddress');
const quickCheckInRating = document.getElementById('quickCheckInRating');
const quickCheckInRatingStars = document.querySelectorAll('#quickCheckInModal .rating-input i');
const quickCheckInPhoto = document.getElementById('quickCheckInPhoto');
const quickCheckInPhotoPreview = document.getElementById('quickCheckInPhotoPreview');

// Êñ∞Â¢ûÔºöÈñãÂïüÂø´ÈÄüÊâìÂç°È†ÅÈù¢
function openQuickCheckInModal() {
    if (!canCheckIn()) return;
    
    quickCheckInModal.classList.add('active');
    document.body.classList.add('modal-open');
    quickCheckInSearch.focus();
}

// Êñ∞Â¢ûÔºöÈóúÈñâÂø´ÈÄüÊâìÂç°È†ÅÈù¢
function closeQuickCheckInModal() {
    quickCheckInModal.classList.remove('active');
    document.body.classList.remove('modal-open');
    quickCheckInForm.reset();
    quickCheckInPhotoPreview.innerHTML = '';
    quickCheckInRatingStars.forEach(star => star.classList.remove('active'));
    quickCheckInStoreInfo.style.display = 'none';
    quickCheckInResults.innerHTML = '';
    quickCheckInSearch.value = '';
}

// Êñ∞Â¢ûÔºöÈÅ∏ÊìáÂ∫óÂÆ∂ÈÄ≤Ë°åÂø´ÈÄüÊâìÂç°
function selectStoreForQuickCheckIn(store) {
    currentStore = store;
    quickCheckInStoreName.textContent = store.name;
    quickCheckInStoreAddress.textContent = store.address;
    quickCheckInStoreInfo.style.display = 'block';
    quickCheckInResults.innerHTML = '';
    quickCheckInSearch.value = store.name;

    // Êõ¥Êñ∞ÈóúÈçµÂ≠óÈÅ∏ÊìáÂçÄÂüü
    const keywordContainer = document.getElementById('quickCheckInKeywordContainer');
    keywordContainer.innerHTML = '';
    
    if (store.keywords && store.keywords.length > 0) {
        store.keywords.forEach(keyword => {
            const keywordBtn = document.createElement('button');
            keywordBtn.type = 'button';
            keywordBtn.className = 'keyword-btn';
            keywordBtn.textContent = `#${keyword}`;
            keywordBtn.dataset.keyword = keyword;
            keywordBtn.addEventListener('click', () => {
                document.querySelectorAll('#quickCheckInModal .keyword-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                keywordBtn.classList.add('selected');
                document.getElementById('quickCheckInSelectedKeyword').value = keyword;
                document.getElementById('quickCheckInOtherKeywordInput').style.display = 'none';
                document.getElementById('quickCheckInOtherKeywordInput').value = '';
            });
            keywordContainer.appendChild(keywordBtn);
        });
    }
    
    // Ê∑ªÂä†"ÂÖ∂‰ªñ"ÈÅ∏È†Ö
    const otherBtn = document.createElement('button');
    otherBtn.type = 'button';
    otherBtn.className = 'keyword-btn';
    otherBtn.textContent = '#ÂÖ∂‰ªñ';
    otherBtn.dataset.keyword = 'other';
    otherBtn.addEventListener('click', () => {
        document.querySelectorAll('#quickCheckInModal .keyword-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        otherBtn.classList.add('selected');
        document.getElementById('quickCheckInOtherKeywordInput').style.display = 'block';
        document.getElementById('quickCheckInOtherKeywordInput').focus();
    });
    keywordContainer.appendChild(otherBtn);
    
    // ÂÖ∂‰ªñÈóúÈçµÂ≠óËº∏ÂÖ•Ê°Ü
    const otherInput = document.createElement('input');
    otherInput.type = 'text';
    otherInput.id = 'quickCheckInOtherKeywordInput';
    otherInput.placeholder = 'Ë´ãËº∏ÂÖ•ÂÖ∂‰ªñÈóúÈçµÂ≠ó';
    otherInput.style.display = 'none';
    otherInput.addEventListener('input', (e) => {
        document.getElementById('quickCheckInSelectedKeyword').value = e.target.value;
    });
    keywordContainer.appendChild(otherInput);
}

// Êñ∞Â¢ûÔºöËôïÁêÜÂø´ÈÄüÊâìÂç°Ë©ïÂàÜÈªûÊìä
function handleQuickCheckInRatingClick(e) {
    const rating = parseInt(e.target.dataset.rating);
    quickCheckInRating.value = rating;
    
    const ratingError = document.querySelector('#quickCheckInModal .rating-error');
    ratingError.style.display = 'none';
    
    quickCheckInRatingStars.forEach(star => {
        const starRating = parseInt(star.dataset.rating);
        star.classList.toggle('active', starRating <= rating);
    });
}

// Êñ∞Â¢ûÔºöËôïÁêÜÂø´ÈÄüÊâìÂç°ÁÖßÁâáÈ†êË¶Ω
function handleQuickCheckInPhotoPreview(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            quickCheckInPhotoPreview.innerHTML = `<img src="${e.target.result}" alt="È†êË¶ΩÁÖßÁâá">`;
        };
        reader.readAsDataURL(file);
    }
}

// Êñ∞Â¢ûÔºöËôïÁêÜÂø´ÈÄüÊâìÂç°Êèê‰∫§
async function handleQuickCheckInSubmit(e) {
    e.preventDefault();
    
    // È©óË≠âÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç
    const ratingValue = quickCheckInRating.value;
    const commentValue = document.getElementById('quickCheckInComment').value.trim();
    const photoFile = quickCheckInPhoto.files[0];
    const selectedKeyword = document.getElementById('quickCheckInSelectedKeyword').value;
    const otherKeywordInput = document.getElementById('quickCheckInOtherKeywordInput');
    
    let hasError = false;
    let finalKeyword = selectedKeyword;
    
    // È©óË≠âÂ∫óÂÆ∂ÈÅ∏Êìá
    const storeError = document.createElement('div');
    storeError.className = 'field-error';
    storeError.style.display = 'none';
    storeError.style.color = '#ff6b6b';
    storeError.style.fontSize = '0.9em';
    storeError.style.marginTop = '5px';
    storeError.textContent = 'Ë´ãÈÅ∏Êìá‰∏ÄÂÆ∂ÊãâÈ∫µÂ∫ó';
    
    const searchBox = document.querySelector('#quickCheckInModal .search-box');
    if (!searchBox.querySelector('.field-error')) {
        searchBox.appendChild(storeError);
    }
    
    if (!currentStore) {
        storeError.style.display = 'block';
        hasError = true;
    } else {
        storeError.style.display = 'none';
    }
    
    // È©óË≠âË©ïÂàÜ
    const ratingError = document.querySelector('#quickCheckInModal .rating-error');
    if (!ratingValue) {
        ratingError.style.display = 'block';
        hasError = true;
    } else {
        ratingError.style.display = 'none';
    }
    
    // È©óË≠âË©ïË´ñ
    const commentError = document.querySelector('#quickCheckInComment').nextElementSibling;
    if (!commentValue) {
        commentError.style.display = 'block';
        hasError = true;
    } else {
        commentError.style.display = 'none';
    }
    
    // È©óË≠âÁÖßÁâá
    const photoError = document.querySelector('#quickCheckInPhoto').nextElementSibling.nextElementSibling;
    if (!photoFile) {
        photoError.style.display = 'block';
        hasError = true;
    } else {
        photoError.style.display = 'none';
    }
    
    // È©óË≠âÈóúÈçµÂ≠ó
    const keywordError = document.querySelector('#quickCheckInModal .keyword-error');
    if (!selectedKeyword) {
        keywordError.style.display = 'block';
        hasError = true;
    } else if (selectedKeyword === 'other') {
        const customKeyword = otherKeywordInput.value.trim();
        if (!customKeyword) {
            keywordError.textContent = 'Ë´ãËº∏ÂÖ•ÂÖ∂‰ªñÈóúÈçµÂ≠ó';
            keywordError.style.display = 'block';
            hasError = true;
        } else {
            finalKeyword = customKeyword;
            keywordError.style.display = 'none';
        }
    } else {
        keywordError.style.display = 'none';
    }
    
    if (hasError) {
        return;
    }

    // Èò≤Ê≠¢ÈáçË§áÊèê‰∫§
    const submitBtn = quickCheckInForm.querySelector('.submit-btn');
    if (submitBtn.disabled) {
        return;
    }
    
    // Ë®≠ÂÆö loading ÁãÄÊÖã
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Êèê‰∫§‰∏≠...';

    // ËôïÁêÜÁÖßÁâá‰∏äÂÇ≥
    let photoUrl = '';
    
    try {
        const formData = new FormData();
        formData.append('file', photoFile);
        
        const uploadResponse = await fetch('https://linebot-fastapi-uhmi.onrender.com/upload', {
            method: 'POST',
            body: formData
        });
        
        if (!uploadResponse.ok) {
            throw new Error('ÁÖßÁâá‰∏äÂÇ≥Â§±Êïó');
        }
        
        const uploadResult = await uploadResponse.json();
        photoUrl = uploadResult.url;
    } catch (error) {
        console.error('Error uploading photo:', error);
        showToast('ÁÖßÁâá‰∏äÂÇ≥Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ÊâìÂç°';
        return;
    }

    const formData = {
        store_id: currentStore.name,
        user_id: currentUser.id,
        rating: parseFloat(ratingValue),
        comment: commentValue,
        photo_url: photoUrl,
        keyword: finalKeyword  // ‰ΩøÁî®ÊúÄÁµÇÁ¢∫ÂÆöÁöÑÈóúÈçµÂ≠ó
    };
    console.log('Submitting form data:', formData);

    try {
        const response = await fetch('https://linebot-fastapi-uhmi.onrender.com/checkin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();
        
        if (response.ok) {
            showToast('ÊâìÂç°ÊàêÂäüÔºÅ');
            closeQuickCheckInModal();
            // ÈáçÊñ∞ËºâÂÖ•ÊâìÂç°Á¥ÄÈåÑ
            const checkinsList = document.querySelector('.checkins-list');
            if (checkinsList) {
                checkinsList.innerHTML = ''; // Ê∏ÖÁ©∫ÁèæÊúâË®òÈåÑ
                loadStoreCheckins(currentStore.id); // ÈáçÊñ∞ËºâÂÖ•
            }
        } else {
            const errorMessage = result.detail || 'Êèê‰∫§Â§±Êïó';
            console.error('Error submitting form:', errorMessage);
            showToast(errorMessage);
        }
    } catch (error) {
        console.error('Error submitting form:', error.message || error);
        showToast('Êèê‰∫§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ÊâìÂç°';
    }
}

// ‰øÆÊîπÔºöËôïÁêÜÊâÄÊúâ URL ÂèÉÊï∏
function handleUrlParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // 1. ËôïÁêÜÁôªÂÖ•ÁãÄÊÖã - ÁßªÂà∞ checkLoginStatus ÂáΩÂºè‰∏≠
    
    // 2. ËôïÁêÜËΩâÁõ§Â∫óÂÆ∂ÂàóË°®
    const idsParam = urlParams.get("store_ids");
    if (idsParam) {
        storeEvents.on('storesLoaded', (stores) => {
            const ramenIds = idsParam.split(",");
            wheelStores = stores.filter(store => ramenIds.includes(String(store.id)));
            // Â¶ÇÊûúÊúâ show_wheel ÂèÉÊï∏ÔºåÂú®Ë®≠ÁΩÆÂÆå wheelStores ÂæåÁ´ãÂç≥Áπ™Ë£ΩËΩâÁõ§
            if (urlParams.get("show_wheel") === "1") {
                const wheelModal = document.getElementById('wheelModal');
                wheelModal.classList.add('active');
                document.body.classList.add('modal-open');
                window.drawWheel();
            }
        });
    } 
    
    // 3. ËôïÁêÜÊòØÂê¶È°ØÁ§∫ËΩâÁõ§ - ÁßªÂà∞ store_ids ËôïÁêÜ‰∏≠
    
    // 4. ËôïÁêÜËá™ÂãïËÅöÁÑ¶ÂñÆ‰∏ÄÂ∫óÂÆ∂
    const storeId = urlParams.get("store_id");
    if (storeId && typeof selectStore === "function") {
        storeEvents.on('storesLoaded', (stores) => {
            // ÂÖàÂòóË©¶Áî® id ÊØîÂ∞ç
            let store = stores.find(s => String(s.id) === String(storeId));
            
            // Â¶ÇÊûúÊâæ‰∏çÂà∞ÔºåÂÜçÂòóË©¶Áî® name ÊØîÂ∞ç
            if (!store) {
                store = stores.find(s => s.name === storeId);
            }
            
            console.log('Found store:', store);
            
            if (store) {
                selectStore(store);
            } else {
                console.error('Store not found with id/name:', storeId);
            }
        });
    }

    // 5. ËôïÁêÜÂø´ÈÄüÊâìÂç°
    if (urlParams.get("quick_checkin") === "1") {
        storeEvents.on('storesLoaded', () => {
            initQuickCheckIn();
            openQuickCheckInModal();
        });
    }
}

// Initialize the map
async function initMap() {
    // Center on Taipei
    const taipei = { lat: 25.0330, lng: 121.5654 };
    //@ts-ignore
    const { Map } = await google.maps.importLibrary("maps");
    const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

    map = new Map(document.getElementById("map"), {
        zoom: 13,
        center: taipei,
        mapId: GOOGLE_MAPS_MAP_ID,
        disableDefaultUI: true
        
    });

    // Â¶ÇÊûúÊúâÁî®Êà∂‰ΩçÁΩÆÔºåË®≠ÁΩÆÂú∞Âúñ‰∏≠ÂøÉÂíåÊ®ôË®ò
    if (currentUser && currentUser.latlng) {
        
        const { latitude, longitude } = currentUser.latlng;
        map.setCenter({ lat: latitude, lng: longitude });
        map.setZoom(17);
        addUserLocationMarker(latitude, longitude);
    }

    // ËÆÄÂèñÊãâÈ∫µÂ∫óË≥áÊñô
    fetch("https://linebot-fastapi-uhmi.onrender.com/all_shops")
        .then(response => response.json())
        .then(data => {
            allStores = data.ramen_stores;
            
            // Ëß∏Áôº stores ËºâÂÖ•ÂÆåÊàê‰∫ã‰ª∂
            storeEvents.emit('storesLoaded', allStores);

            data.ramen_stores.forEach(store => {
                const position = {
                    lat: store.location.latitude,
                    lng: store.location.longitude
                };

                // marker ÂÖßÂÆπÂè™ÊîæÂúñÁâá
                const markerContent = document.createElement("div");
                markerContent.className = "marker-content";

                // ÂúñÁâá
                const ramenImg = document.createElement("img");
                ramenImg.src = "./src/assets/images/ramen-marker.jpg";
                ramenImg.className = "ramen-marker-img";

                markerContent.appendChild(ramenImg);

                const nameDiv = document.createElement("div");
                nameDiv.textContent = store.name;
                nameDiv.className = "marker-store-name";
                markerContent.appendChild(nameDiv);

                // Âª∫Á´ã marker
                const marker = new AdvancedMarkerElement({
                    map,
                    position,
                    content: markerContent,
                    title: store.name,
                    gmpClickable: true
                });

                // ÂÑ≤Â≠òÊ®ôË®òÂíåÂ∫óÂÆ∂ÁöÑÈóúËÅØ
                marker.store = store;
                allMarkers.push(marker);

                // ÈªûÊìä marker ÊôÇÈ°ØÁ§∫Â∫óÂêçÂíåÊâìÂç°ÊåâÈàï
                marker.addListener("gmp-click", () => {
                    renderStoreInfo(store);
                    panMapToSafeBounds(map, position);
                    showCheckInButton(store);
                });

                // ÈªûÊìäÂú∞ÂúñÂÖ∂‰ªñÂú∞ÊñπÊôÇÈö±ËóèÂ∫óÂêçÂíåÊâìÂç°ÊåâÈàï
                map.addListener("click", () => {
                    showDefaultPage();
                    hideCheckInButton();
                    showAllMarkers();
                });
            });
        })
        .catch(error => console.error('Error loading ramen data:', error));
}

// Â∫ïÈÉ®Èù¢ÊùøÊªæÂãïÊéßÂà∂
const ramenList = document.getElementById('ramenList');
const ramenListHandle = document.querySelector('.ramen-list-handle');
let lastScrollTop = 0;
let isScrolling = false;
let scrollTimeout;

// ÈªûÊìäÊâãÊüÑÂàáÊèõÈù¢ÊùøÁãÄÊÖã
ramenListHandle.addEventListener('click', () => {
    ramenList.classList.toggle('active');
    if (ramenList.classList.contains('active')) {
        ramenList.style.transform = 'translateY(0)';
    } else {
        ramenList.style.transform = 'translateY(calc(100% - 50px))';
    }
});

// Áõ£ËÅΩÈù¢ÊùøÊªæÂãï
ramenList.addEventListener('scroll', () => {
    if (!isScrolling) {
        isScrolling = true;
        clearTimeout(scrollTimeout);
    }

    const currentScroll = ramenList.scrollTop;
    const scrollDirection = currentScroll > lastScrollTop ? 'down' : 'up';

    if (scrollDirection === 'down') {
        ramenList.classList.add('active');
        ramenList.style.transform = 'translateY(0)';
        ramenList.style.maxHeight = '80vh';
    }

    lastScrollTop = currentScroll;

    scrollTimeout = setTimeout(() => {
        isScrolling = false;
    }, 150);
});

// Â∞áË©≥Á¥∞Ë≥áË®äÊ∏≤ÊüìÂà∞Âè≥ÂÅ¥Ê¨Ñ
function renderStoreInfo(store) {
    const ramenItems = document.getElementById('ramenItems');
    
    // ÂâµÂª∫Ê®ôÁ±§È†ÅÂÆπÂô®
    ramenItems.innerHTML = `
        <div class="store-info-full">
            <div class="tabs">
                <button class="tab-btn active" data-tab="info">Â∫óÂÆ∂Ë≥áË®ä</button>
                <button class="tab-btn" data-tab="checkins">ÊâìÂç°Á¥ÄÈåÑ</button>
            </div>
            
            <div class="tab-content">
                <div class="tab-pane active" id="info-tab">
                    <div class="store-header">
                        <div class="store-title">${store.name}</div>
                        <div class="store-address"><i class='fas fa-map-marker-alt'></i> ${store.address || ''}</div>
                    </div>
                    <div class="store-section">
                        <div class="store-label">Ë©ïÂàÜ</div>
                        <div class="store-value"><i class="fas fa-star" style="color: #F1C40F;"></i> ${store.rating}</div>
                    </div>
                    <div class="store-section">
                        <div class="store-label">ÈóúÈçµÂ≠ó</div>
                        <div class="store-value">
                            ${store.keywords ? store.keywords.map(kw => `<b>#${kw}</b>`).join(' ') : ''}
                        </div>
                    </div>
                    <div class="store-section">
                        <div class="store-label">ÁáüÊ•≠ÊôÇÈñì</div>
                        <div class="store-value">${store.open_time ? store.open_time.replace(/; ?/g, '<br>') : 'ÁÑ°Ë≥áÊñô'}</div>
                    </div>
                    <div class="store-menu-img">
                        <div class="menu-title">ËèúÂñÆ</div>
                        <img src="${store.menu_image || ''}" alt="${store.name} ËèúÂñÆ" style="width:100%;max-width:350px;margin:10px auto 0;display:block;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);background:#fafafa;" />
                    </div>
                </div>
                
                <div class="tab-pane" id="checkins-tab">
                    <div class="checkins-container">
                        <div class="checkins-list"></div>
                        <button class="load-more-btn" style="display: none;">È°ØÁ§∫Êõ¥Â§ö</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // ÂàùÂßãÂåñÊâìÂç°Á¥ÄÈåÑ
    loadStoreCheckins(store.id);

    // Á∂ÅÂÆöÊ®ôÁ±§È†ÅÂàáÊèõ‰∫ã‰ª∂
    const tabBtns = ramenItems.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const tabPanes = ramenItems.querySelectorAll('.tab-pane');
            tabPanes.forEach(pane => pane.classList.remove('active'));
            ramenItems.querySelector(`#${btn.dataset.tab}-tab`).classList.add('active');
        });
    });

    ramenList.classList.add('active');
    ramenList.style.transform = 'translateY(0)';
    ramenList.style.maxHeight = 'var(--panel-height)';
}

// Êñ∞Â¢ûÔºöËºâÂÖ•Â∫óÂÆ∂ÊâìÂç°Á¥ÄÈåÑ
async function loadStoreCheckins(storeId, lastId = null) {
    try {
        const url = `https://linebot-fastapi-uhmi.onrender.com/store_checkins/${storeId}?limit=5` + (lastId ? `&last_id=${lastId}` : '');
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.status === "success") {
            const checkinsList = document.querySelector('.checkins-list');
            const loadMoreBtn = document.querySelector('.load-more-btn');
            
            // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊ¨°ËºâÂÖ•‰∏îÊ≤íÊúâÊâìÂç°Ë®òÈåÑ
            if (!lastId && data.checkins.length === 0) {
                checkinsList.innerHTML = `
                    <div class="no-checkins-message">
                        <i class="fas fa-utensils"></i>
                        <p>ÈÇÑÊ≤íÊúâ‰ªª‰ΩïÊâìÂç°Ë®òÈåÑ</p>
                        <p class="sub-text">‰æÜÁï∂Á¨¨‰∏ÄÂÄãÊâìÂç°ÁöÑ‰∫∫ÂêßÔºÅ</p>
                    </div>
                `;
                loadMoreBtn.style.display = 'none';
                return;
            }
            
            // Ê∏≤ÊüìÊâìÂç°Á¥ÄÈåÑ
            data.checkins.forEach(checkin => {
                const checkinElement = createCheckinElement(checkin);
                checkinsList.appendChild(checkinElement);
            });
            
            // ÊéßÂà∂"È°ØÁ§∫Êõ¥Â§ö"ÊåâÈàïÂíåÂà∞Â∫ïÊèêÁ§∫
            if (data.has_more) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.onclick = () => {
                    const lastCheckin = data.checkins[data.checkins.length - 1];
                    loadStoreCheckins(storeId, lastCheckin.id);
                };
            } else {
                const endMessage = document.createElement('div');
                endMessage.className = 'end-message';
                endMessage.innerHTML = `
                    <i class="fas fa-flag-checkered"></i>
                    <p>Â∑≤Á∂ìÂà∞Â∫ï‰∫ÜÔºÅ</p>
                `;
                checkinsList.appendChild(endMessage);
                loadMoreBtn.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Error loading checkins:', error);
        showToast('ËºâÂÖ•ÊâìÂç°Á¥ÄÈåÑÂ§±Êïó');
    }
}

// Êñ∞Â¢ûÔºöÂâµÂª∫ÊâìÂç°Á¥ÄÈåÑÂÖÉÁ¥†
function createCheckinElement(checkin) {
    const div = document.createElement('div');
    div.className = 'checkin-item';
    div.innerHTML = `
        <div class="checkin-header">
            <div class="checkin-user">${checkin.user_name}</div>
            <div class="checkin-time">${formatDate(checkin.timestamp)}</div>
        </div>
        <div class="checkin-content">
            <div class="checkin-keyword">#${checkin.keyword || 'ÂÖ∂‰ªñ'}</div>
            <div class="checkin-rating">
                <div class="stars">${'‚òÖ'.repeat(Math.round(checkin.rating))}${'‚òÜ'.repeat(5 - Math.round(checkin.rating))}</div>
                <div class="rating-value">${checkin.rating}</div>
            </div>
            <div class="checkin-comment">${checkin.comment}</div>
            ${checkin.photo_url ? `
                <div class="checkin-photo">
                    <img src="${checkin.photo_url}" alt="ÊâìÂç°ÁÖßÁâá" />
                </div>
            ` : ''}
        </div>
    `;
    return div;
}

// Êñ∞Â¢ûÔºöÊ†ºÂºèÂåñÊó•Êúü
function formatDate(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// ÈªûÊìäÂú∞ÂúñÁ©∫ÁôΩËôïÊôÇÔºåÊÅ¢Âæ©È†êË®≠ÁãÄÊÖã
function showDefaultPage() {
    const ramenItems = document.getElementById('ramenItems');
    if (ramenItems) ramenItems.innerHTML = '';

    ramenList.classList.remove('active');
    ramenList.style.transform = 'translateY(calc(100% - 50px))';
    ramenList.style.maxHeight = 'var(--panel-height)';

    // È°ØÁ§∫ÊâÄÊúâÊ®ôË®ò
    showAllMarkers();
}

// Ê™¢Êü•‰∏¶ÁßªÂãïÂú∞ÂúñÔºåÁ¢∫‰øùÊ®ôË®òÂú®ÂÆâÂÖ®ÁØÑÂúçÂÖß
function panMapToSafeBounds(map, position) {
    const bounds = map.getBounds();
    if (!bounds) return;

    const ne = bounds.getNorthEast();
    const sw = bounds.getSouthWest();
    const latPadding = (ne.lat() - sw.lat()) * 0.2;
    const lngPadding = (ne.lng() - sw.lng()) * 0.2;

    const safeBounds = {
        north: ne.lat() - latPadding,
        south: sw.lat() + latPadding,
        east: ne.lng() - lngPadding,
        west: sw.lng() + lngPadding
    };

    if (position.lat > safeBounds.north || 
        position.lat < safeBounds.south || 
        position.lng > safeBounds.east || 
        position.lng < safeBounds.west) {
        const newCenter = {
            lat: position.lat > safeBounds.north ? safeBounds.north - latPadding * 0.5 :
                 position.lat < safeBounds.south ? safeBounds.south + latPadding * 0.5 :
                 map.getCenter().lat(),
            lng: position.lng > safeBounds.east ? safeBounds.east - lngPadding * 0.5 :
                 position.lng < safeBounds.west ? safeBounds.west + lngPadding * 0.5 :
                 map.getCenter().lng()
        };
        map.panTo(newCenter);
    }
}

// ÊâìÂç°ÂäüËÉΩÁõ∏ÈóúÁöÑ DOM ÂÖÉÁ¥†
const checkInFab = document.getElementById('checkInFab');
const checkInModal = document.getElementById('checkInModal');
const closeModal = document.querySelector('.close-modal');
const checkInForm = document.getElementById('checkInForm');
const storeNameElement = document.getElementById('checkInStoreName');
const storeAddressElement = document.getElementById('checkInStoreAddress');
const ratingInput = document.getElementById('storeRating');
const ratingStars = document.querySelectorAll('.rating-input i');
const photoInput = document.getElementById('checkInPhoto');
const photoPreview = document.getElementById('photoPreview');

// ÈñãÂïüÊâìÂç°È†ÅÈù¢
function openCheckInModal(store) {
    currentStore = store;
    storeNameElement.textContent = store.name;
    storeAddressElement.textContent = store.address;
    
    // Êñ∞Â¢ûÔºöÊõ¥Êñ∞ÈóúÈçµÂ≠óÈÅ∏ÊìáÂçÄÂüü
    const keywordContainer = document.getElementById('keywordContainer');
    keywordContainer.innerHTML = ''; // Ê∏ÖÁ©∫ÁèæÊúâÈóúÈçµÂ≠ó
    
    if (store.keywords && store.keywords.length > 0) {
        store.keywords.forEach(keyword => {
            const keywordBtn = document.createElement('button');
            keywordBtn.type = 'button';
            keywordBtn.className = 'keyword-btn';
            keywordBtn.textContent = `#${keyword}`;
            keywordBtn.dataset.keyword = keyword;
            keywordBtn.addEventListener('click', () => {
                // ÁßªÈô§ÂÖ∂‰ªñÊåâÈàïÁöÑÈÅ∏‰∏≠ÁãÄÊÖã
                document.querySelectorAll('.keyword-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                // ÈÅ∏‰∏≠Áï∂ÂâçÊåâÈàï
                keywordBtn.classList.add('selected');
                // Êõ¥Êñ∞Èö±ËóèÁöÑËº∏ÂÖ•Ê¨Ñ‰Ωç
                document.getElementById('selectedKeyword').value = keyword;
                // Èö±ËóèÂÖ∂‰ªñÈóúÈçµÂ≠óËº∏ÂÖ•Ê°Ü
                document.getElementById('otherKeywordInput').style.display = 'none';
                document.getElementById('otherKeywordInput').value = '';
            });
            keywordContainer.appendChild(keywordBtn);
        });
    }
    
    // Êñ∞Â¢ûÔºöÊ∑ªÂä†"ÂÖ∂‰ªñ"ÈÅ∏È†Ö
    const otherBtn = document.createElement('button');
    otherBtn.type = 'button';
    otherBtn.className = 'keyword-btn';
    otherBtn.textContent = '#ÂÖ∂‰ªñ';
    otherBtn.dataset.keyword = 'other';
    otherBtn.addEventListener('click', () => {
        // ÁßªÈô§ÂÖ∂‰ªñÊåâÈàïÁöÑÈÅ∏‰∏≠ÁãÄÊÖã
        document.querySelectorAll('.keyword-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        // ÈÅ∏‰∏≠Áï∂ÂâçÊåâÈàï
        otherBtn.classList.add('selected');
        // È°ØÁ§∫ÂÖ∂‰ªñÈóúÈçµÂ≠óËº∏ÂÖ•Ê°Ü
        document.getElementById('otherKeywordInput').style.display = 'block';
        document.getElementById('otherKeywordInput').focus();
    });
    keywordContainer.appendChild(otherBtn);
    
    // Êñ∞Â¢ûÔºöÂÖ∂‰ªñÈóúÈçµÂ≠óËº∏ÂÖ•Ê°Ü
    const otherInput = document.createElement('input');
    otherInput.type = 'text';
    otherInput.id = 'otherKeywordInput';
    otherInput.placeholder = 'Ë´ãËº∏ÂÖ•ÂÖ∂‰ªñÈóúÈçµÂ≠ó';
    otherInput.style.display = 'none';
    otherInput.addEventListener('input', (e) => {
        document.getElementById('selectedKeyword').value = e.target.value;
    });
    keywordContainer.appendChild(otherInput);
    
    checkInModal.classList.add('active');
    document.body.classList.add('modal-open');
}

// ÈóúÈñâÊâìÂç°È†ÅÈù¢
function closeCheckInModal() {
    checkInModal.classList.remove('active');
    document.body.classList.remove('modal-open');
    checkInForm.reset();
    photoPreview.innerHTML = '';
    ratingStars.forEach(star => star.classList.remove('active'));
}

// ËôïÁêÜË©ïÂàÜÊòüÊòüÈªûÊìä
function handleRatingClick(e) {
    const rating = parseInt(e.target.dataset.rating);
    ratingInput.value = rating;
    
    // Èö±ËóèÈåØË™§Ë®äÊÅØ
    const ratingError = document.querySelector('.rating-error');
    ratingError.style.display = 'none';
    
    ratingStars.forEach(star => {
        const starRating = parseInt(star.dataset.rating);
        star.classList.toggle('active', starRating <= rating);
    });
}

// ËôïÁêÜÁÖßÁâáÈ†êË¶Ω
function handlePhotoPreview(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            photoPreview.innerHTML = `<img src="${e.target.result}" alt="È†êË¶ΩÁÖßÁâá">`;
        };
        reader.readAsDataURL(file);
    }
}

// È°ØÁ§∫ÊâìÂç°ÊåâÈàï
function showCheckInButton(store) {
    currentStore = store;
    checkInFab.classList.add('active');
    addToWheelFab.classList.add('active');
    updateAddToWheelButton(store); // Êñ∞Â¢ûÔºöÊõ¥Êñ∞ÊåâÈàïÂúñÁ§∫
}

// Èö±ËóèÊâìÂç°ÊåâÈàï
function hideCheckInButton() {
    currentStore = null;
    checkInFab.classList.remove('active');
    addToWheelFab.classList.remove('active');
}

// Êñ∞Â¢ûÔºöÊ™¢Êü•ÊòØÂê¶ÂèØ‰ª•ÊâìÂç°
function canCheckIn() {
    if (!currentUser) {
        showToast('Ë´ãÂÖàËá≥LINEBOTÁôªÂÖ•ÔºÅ');
        return false;
    }
    return true;
}

// Êñ∞Â¢ûÔºöÁç≤ÂèñÈôÑËøëÁöÑÊãâÈ∫µÂ∫ó
async function getNearbyShops(lat, lng, limit = 6) {
    try {
        const response = await fetch(`https://linebot-fastapi-uhmi.onrender.com/nearby_shops?lat=${lat}&lng=${lng}&limit=${limit}`);
        const data = await response.json();
        if (data.status === "success") {
            return data.shops;
        }
        return [];
    } catch (error) {
        console.error('Error getting nearby shops:', error);
        return [];
    }
}

// Êñ∞Â¢ûÔºöÈö®Ê©üÈÅ∏ÊìáÊãâÈ∫µÂ∫ó
function getRandomShops(limit = 6) {
    const shuffled = [...allStores].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, limit);
}

// ÊãâÈ∫µËΩâÁõ§ÂäüËÉΩ
async function initWheel() {
    const wheelFab = document.getElementById('wheelFab');
    const wheelModal = document.getElementById('wheelModal');
    const closeWheelModal = document.getElementById('closeWheelModal');
    const spinButton = document.getElementById('spinButton');
    const confirmButton = document.getElementById('confirmButton');
    const canvas = document.getElementById('wheelCanvas');
    const selectedStoreName = document.getElementById('selectedStoreName');
    const ctx = canvas.getContext('2d');
    const addToWheelFab = document.getElementById('addToWheelFab');

    canvas.width = 300;
    canvas.height = 300;

    let currentRotation = 0;
    let isSpinning = false;
    let selectedStore = null;

    // Êñ∞Â¢ûÔºöÂàùÂßãÂåñÊôÇÂä†ÂÖ•ÈôÑËøëÁöÑÊãâÈ∫µÂ∫ó
    if (currentUser && currentUser.latlng) {
        const { latitude, longitude } = currentUser.latlng;
        const nearbyShops = await getNearbyShops(latitude, longitude);
        if (nearbyShops.length > 0) {
            wheelStores = nearbyShops;
        } else {
            wheelStores = getRandomShops();
        }
    } else {
        wheelStores = getRandomShops();
    }

    // ‰øÆÊîπÔºöÂä†ÂÖ•/ÁßªÈô§ËΩâÁõ§ÁöÑÂäüËÉΩ
    addToWheelFab.addEventListener('click', () => {
        if (currentStore) {
            const isInWheel = isStoreInWheel(currentStore);
            
            if (!isInWheel) {
                wheelStores.push(currentStore);
                showToast('üéâÂ∑≤Â∞áÂ∫óÂÆ∂Âä†ÂÖ•ËΩâÁõ§üéâ');
            } else {
                // ÂæûËΩâÁõ§‰∏≠ÁßªÈô§Â∫óÂÆ∂
                wheelStores = wheelStores.filter(store => 
                    !(store.name === currentStore.name && 
                      store.address === currentStore.address)
                );
                showToast('üóëÔ∏èÂ∑≤ÂæûËΩâÁõ§ÁßªÈô§Â∫óÂÆ∂üóëÔ∏è');
            }
            
            // Êõ¥Êñ∞ÊåâÈàïÂúñÁ§∫
            updateAddToWheelButton(currentStore);
            
            // Â¶ÇÊûúËΩâÁõ§Ë¶ñÁ™óÊòØÈñãÂïüÁöÑÔºåÈáçÊñ∞Áπ™Ë£ΩËΩâÁõ§
            if (wheelModal.classList.contains('active')) {
                drawWheel();
            }
        }
    });

    // Â∞á drawWheel ÂáΩÊï∏Ë®≠ÁÇ∫ÂÖ®Â±ÄÂèØË®™Âïè
    window.drawWheel = function() {
        console.log('drawWheel called, wheelStores:', wheelStores);
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(centerX, centerY) - 10;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (wheelStores.length === 0) {
            console.log('wheelStores is empty in drawWheel');
            // Â¶ÇÊûúËΩâÁõ§ÁÇ∫Á©∫ÔºåÈ°ØÁ§∫ÊèêÁ§∫ÊñáÂ≠ó
            ctx.fillStyle = '#f8f9fa';
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.fillStyle = '#666';
            ctx.font = '16px Noto Sans JP';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Ë´ãÂÖàÂä†ÂÖ•Â∫óÂÆ∂', centerX, centerY);
            return;
        }
        
        const anglePerSlice = (2 * Math.PI) / wheelStores.length;
        
        wheelStores.forEach((store, index) => {
            const startAngle = index * anglePerSlice + currentRotation;
            const endAngle = (index + 1) * anglePerSlice + currentRotation;
            
            const colors = ['#E87A90', '#88C9A1', '#F7B977'];
            let colorIndex;
            if (index === wheelStores.length - 1) {
                const prevColor = (index - 1) % 3;
                const firstColor = 0;
                colorIndex = colors.findIndex((_, i) => i !== prevColor && i !== firstColor);
            } else {
                colorIndex = index % 3;
            }
            ctx.fillStyle = colors[colorIndex];
            
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.closePath();
            ctx.fill();
            
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(startAngle + anglePerSlice / 2);
            ctx.textAlign = 'right';
            ctx.fillStyle = 'white';
            ctx.font = '14px Noto Sans JP';
            ctx.fillText(store.name, radius - 20, 5);
            ctx.restore();
        });
        
        ctx.beginPath();
        ctx.arc(centerX, centerY, 10, 0, 2 * Math.PI);
        ctx.fillStyle = '#2C3E50';
        ctx.fill();
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY - radius);
        ctx.lineTo(centerX - 10, centerY - radius + 20);
        ctx.lineTo(centerX + 10, centerY - radius + 20);
        ctx.closePath();
        ctx.fillStyle = '#2C3E50';
        ctx.fill();
    };

    // Â∞á spinWheel ÂáΩÊï∏Ë®≠ÁÇ∫ÂÖ®Â±ÄÂèØË®™Âïè
    window.spinWheel = function() {
        if (isSpinning || wheelStores.length === 0) return;
        
        isSpinning = true;
        spinButton.disabled = true;
        confirmButton.disabled = true;
        selectedStoreName.textContent = 'ËΩâÂãï‰∏≠...';
        
        const spinAngle = (Math.random() * 5 + 5) * 2 * Math.PI;
        const duration = 3000;
        const startTime = performance.now();
        
        function animate(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            const easeProgress = 1 - (1 - progress) * (1 - progress);
            
            currentRotation = spinAngle * easeProgress;
            drawWheel();
            
            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                isSpinning = false;
                spinButton.disabled = false;
                confirmButton.disabled = false;
                
                const anglePerSlice = (2 * Math.PI) / wheelStores.length;
                const pointerAngle = -Math.PI / 2;
                let idx = ((pointerAngle - currentRotation) % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI) / anglePerSlice;
                const selectedIndex = Math.floor(idx);
                selectedStore = wheelStores[selectedIndex];
                selectedStoreName.textContent = selectedStore.name;
            }
        }
        
        requestAnimationFrame(animate);
    };

    wheelFab.addEventListener('click', () => {
        console.log('wheelFab clicked, wheelStores:', wheelStores);
        wheelModal.classList.add('active');
        document.body.classList.add('modal-open');
        drawWheel();
    });

    canvas.addEventListener('click', () => {
        if (!isSpinning && wheelStores.length > 0) {
            spinWheel();
        }
    });

    closeWheelModal.addEventListener('click', () => {
        wheelModal.classList.remove('active');
        document.body.classList.remove('modal-open');
    });

    spinButton.addEventListener('click', spinWheel);

    confirmButton.addEventListener('click', () => {
        if (selectedStore) {
            selectStore(selectedStore);
            wheelModal.classList.remove('active');
            document.body.classList.remove('modal-open');
        }
    });

    wheelModal.addEventListener('click', (e) => {
        if (e.target === wheelModal) {
            wheelModal.classList.remove('active');
            document.body.classList.remove('modal-open');
        }
    });
}

// Êñ∞Â¢ûÔºöÂè™È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÊ®ôË®ò
function showOnlySelectedMarker(selectedMarker) {
    allMarkers.forEach(marker => {
        if (marker === selectedMarker) {
            marker.map = map;
        } else {
            marker.map = null;
        }
    });
}

// Êñ∞Â¢ûÔºöÈ°ØÁ§∫ÊâÄÊúâÊ®ôË®ò
function showAllMarkers() {
    allMarkers.forEach(marker => {
        marker.map = map;
    });
}

// Êñ∞Â¢ûÔºöÊéßÂà∂ loading ÈÅÆÁΩ©
function showLoading() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
    }
}

function hideLoading() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}

async function loadLiffScript() {
    return new Promise((resolve, reject) => {
        if (window.liff) return resolve();
        const script = document.createElement("script");
        script.src = "https://static.line-scdn.net/liff/edge/2/sdk.js";
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

async function ensureUserIdParam() {
    // Ê™¢Êü• user_idÔºå‰∏çË¶ÅÁõ¥Êé•Áî® searchÔºåÈÇÑË¶ÅÊîØÊè¥ hash
    let urlParams = new URLSearchParams(window.location.search);

    // Â¶ÇÊûú search Ê≤íÂèÉÊï∏„ÄÅ‰ΩÜ hash ÊúâÔºåÂ∞±Êää hash ÊãÜÊàê query string
    if (!window.location.search && window.location.hash) {
        // Êää hash ÈñãÈ†≠ÁöÑ # ÊãøÊéâ
        const hashString = window.location.hash.substring(1);
        urlParams = new URLSearchParams(hashString);
        // Áõ¥Êé•ËΩâÊèõÊàê ? ÂèÉÊï∏ÂÜç reload
        window.location.search = '?' + hashString;
        return;
    }

    // ‰ª•‰∏ãÁ∂≠ÊåÅ‰Ω†ÁöÑ user_id Âà§Êñ∑ÊµÅÁ®ã
    if (!urlParams.has("user_id")) {
        await loadLiffScript();
        await liff.init({ liffId: "2007489792-4popYn8a" });
        if (!liff.isInClient()) {
            showToast("Ë´ãÂæûLINEÂúñÊñáÈÅ∏ÂñÆÊâìÈñãÊú¨È†ÅÔºÅ");
            return;
        }
        const profile = await liff.getProfile();
        const userId = profile.userId;

        urlParams.set('user_id', userId);
        const searchString = urlParams.toString();
        window.location.href = `https://frontend-7ivv.onrender.com/ramen-map/?${searchString}`;
    }
}

// Êñ∞Â¢ûÔºöÂõûÂà∞Áî®Êà∂‰ΩçÁΩÆ
function centerOnUserLocation() {
    if (currentUser && currentUser.latlng) {
        const { latitude, longitude } = currentUser.latlng;
        map.setCenter({ lat: latitude, lng: longitude });
        map.setZoom(17);
    } else {
        showToast('ÁÑ°Ê≥ïÁç≤ÂèñÊÇ®ÁöÑ‰ΩçÁΩÆ');
    }
}

// Êñ∞Â¢ûÔºöËôïÁêÜÊâìÂç°Êèê‰∫§
async function handleCheckInSubmit(e) {
    e.preventDefault();
    
    if (!currentStore) {
        alert('Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂÆ∂ÊãâÈ∫µÂ∫ó');
        return;
    }

    // È©óË≠âÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç
    const ratingValue = ratingInput.value;
    const commentValue = document.getElementById('storeComment').value.trim();
    const photoFile = photoInput.files[0];
    const selectedKeyword = document.getElementById('selectedKeyword').value;
    const otherKeywordInput = document.getElementById('otherKeywordInput');
    
    let hasError = false;
    let finalKeyword = selectedKeyword;
    
    // È©óË≠âË©ïÂàÜ
    const ratingError = document.querySelector('.rating-error');
    if (!ratingValue) {
        ratingError.style.display = 'block';
        hasError = true;
    } else {
        ratingError.style.display = 'none';
    }
    
    // È©óË≠âË©ïË´ñ
    const commentError = document.querySelector('#storeComment').nextElementSibling;
    if (!commentValue) {
        commentError.style.display = 'block';
        hasError = true;
    } else {
        commentError.style.display = 'none';
    }
    
    // È©óË≠âÁÖßÁâá
    const photoError = document.querySelector('#checkInPhoto').nextElementSibling.nextElementSibling;
    if (!photoFile) {
        photoError.style.display = 'block';
        hasError = true;
    } else {
        photoError.style.display = 'none';
    }
    
    // È©óË≠âÈóúÈçµÂ≠ó
    const keywordError = document.querySelector('.keyword-error');
    if (!selectedKeyword) {
        keywordError.style.display = 'block';
        hasError = true;
    } else if (selectedKeyword === 'other') {
        const customKeyword = otherKeywordInput.value.trim();
        if (!customKeyword) {
            keywordError.textContent = 'Ë´ãËº∏ÂÖ•ÂÖ∂‰ªñÈóúÈçµÂ≠ó';
            keywordError.style.display = 'block';
            hasError = true;
        } else {
            finalKeyword = customKeyword;
            keywordError.style.display = 'none';
        }
    } else {
        keywordError.style.display = 'none';
    }

    if (hasError) {
        return;
    }

    // Èò≤Ê≠¢ÈáçË§áÊèê‰∫§
    const submitBtn = checkInForm.querySelector('.submit-btn');
    if (submitBtn.disabled) {
        return;
    }
    
    // Ë®≠ÂÆö loading ÁãÄÊÖã
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Êèê‰∫§‰∏≠...';

    // ËôïÁêÜÁÖßÁâá‰∏äÂÇ≥
    let photoUrl = '';
    
    try {
        // Âª∫Á´ã FormData Áâ©‰ª∂
        const formData = new FormData();
        formData.append('file', photoFile);
        
        // ‰∏äÂÇ≥ÁÖßÁâáÂà∞ÂæåÁ´Ø
        const uploadResponse = await fetch('https://linebot-fastapi-uhmi.onrender.com/upload', {
            method: 'POST',
            body: formData
        });
        
        if (!uploadResponse.ok) {
            throw new Error('ÁÖßÁâá‰∏äÂÇ≥Â§±Êïó');
        }
        
        const uploadResult = await uploadResponse.json();
        photoUrl = uploadResult.url;
    } catch (error) {
        console.error('Error uploading photo:', error);
        showToast('ÁÖßÁâá‰∏äÂÇ≥Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
        // ÈáçÁΩÆÊåâÈàïÁãÄÊÖã
        submitBtn.disabled = false;
        submitBtn.textContent = 'ÊâìÂç°';
        return;
    }

    const formData = {
        store_id: currentStore.name,
        user_id: currentUser.id,
        rating: parseFloat(ratingValue),
        comment: commentValue,
        photo_url: photoUrl,
        keyword: finalKeyword  // ‰ΩøÁî®ÊúÄÁµÇÁ¢∫ÂÆöÁöÑÈóúÈçµÂ≠ó
    };
    console.log('Submitting form data:', formData);

    try {
        const response = await fetch('https://linebot-fastapi-uhmi.onrender.com/checkin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();
        
        if (response.ok) {
            showToast('ÊâìÂç°ÊàêÂäüÔºÅ');
            closeCheckInModal();
            // ÈáçÊñ∞ËºâÂÖ•ÊâìÂç°Á¥ÄÈåÑ
            const checkinsList = document.querySelector('.checkins-list');
            if (checkinsList) {
                checkinsList.innerHTML = ''; // Ê∏ÖÁ©∫ÁèæÊúâË®òÈåÑ
                loadStoreCheckins(currentStore.id); // ÈáçÊñ∞ËºâÂÖ•
            }
        } else {
            const errorMessage = result.detail || 'Êèê‰∫§Â§±Êïó';
            console.error('Error submitting form:', errorMessage);
            showToast(errorMessage);
        }
    } catch (error) {
        console.error('Error submitting form:', error.message || error);
        showToast('Êèê‰∫§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
    } finally {
        // ÈáçÁΩÆÊåâÈàïÁãÄÊÖã
        submitBtn.disabled = false;
        submitBtn.textContent = 'ÊâìÂç°';
    }
}

// Êñ∞Â¢ûÔºöÂàùÂßãÂåñÂø´ÈÄüÊâìÂç°ÂäüËÉΩ
function initQuickCheckIn() {
    const quickCheckInModal = document.getElementById('quickCheckInModal');
    const quickCheckInSearch = document.getElementById('quickCheckInSearch');
    const quickCheckInResults = document.getElementById('quickCheckInResults');
    const quickCheckInForm = document.getElementById('quickCheckInForm');
    const quickCheckInStoreInfo = document.querySelector('#quickCheckInModal .store-info');
    const quickCheckInStoreName = document.getElementById('quickCheckInStoreName');
    const quickCheckInStoreAddress = document.getElementById('quickCheckInStoreAddress');
    const quickCheckInRating = document.getElementById('quickCheckInRating');
    const quickCheckInRatingStars = document.querySelectorAll('#quickCheckInModal .rating-input i');
    const quickCheckInPhoto = document.getElementById('quickCheckInPhoto');
    const quickCheckInPhotoPreview = document.getElementById('quickCheckInPhotoPreview');

    // Âø´ÈÄüÊâìÂç°ÂäüËÉΩ‰∫ã‰ª∂Áõ£ËÅΩ
    const quickCheckInCloseModal = document.querySelector('#quickCheckInModal .close-modal');
    
    quickCheckInCloseModal.addEventListener('click', closeQuickCheckInModal);

    quickCheckInModal.addEventListener('click', (e) => {
        if (e.target === quickCheckInModal) {
            closeQuickCheckInModal();
        }
    });

    // ‰øÆÊîπÔºöÂü∑Ë°åÂø´ÈÄüÊâìÂç°ÊêúÂ∞ãÁöÑÂáΩÊï∏
    const performQuickCheckInSearch = () => {
        searchStores(quickCheckInSearch.value, true, true, true);
    };

    // Êåâ‰∏ã Enter ÊôÇÊêúÂ∞ã
    quickCheckInSearch.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            performQuickCheckInSearch();
        }
    });

    // Âç≥ÊôÇÊêúÂ∞ãÔºå‰∏çÈ°ØÁ§∫Êâæ‰∏çÂà∞ÁöÑÊèêÁ§∫Ôºå‰∏çÈÅ∏‰∏≠Á¨¨‰∏ÄÂÄã
    quickCheckInSearch.addEventListener('input', (e) => {
        searchStores(e.target.value, false, false, true);
        if (e.target.value.trim() !== '') {
            quickCheckInResults.classList.add('active');
        } else {
            quickCheckInResults.classList.remove('active');
        }
    });

    quickCheckInRatingStars.forEach(star => {
        star.addEventListener('click', handleQuickCheckInRatingClick);
    });

    quickCheckInPhoto.addEventListener('change', handleQuickCheckInPhotoPreview);

    quickCheckInForm.addEventListener('submit', handleQuickCheckInSubmit);
}

// ‰øÆÊîπÔºöÂàùÂßãÂåñÊâÄÊúâÂäüËÉΩ
async function init() {
    showLoading();
    
    try {
        // 1. Á¢∫‰øùÊúâ user_id
        await ensureUserIdParam();

        await checkLoginStatus();

        // 2. ÂàùÂßãÂåñÂú∞Âúñ‰∏¶Áç≤ÂèñÊâÄÊúâÊãâÈ∫µÂ∫óË≥áÊñô
        await initMap();

        // 3. Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖã‰∏¶Áç≤ÂèñÁî®Êà∂Ë≥áÊñô
        

        // 4. ÂàùÂßãÂåñËΩâÁõ§ÔºàÈúÄË¶Å allStores Âíå currentUser Êï∏ÊìöÔºâ
        await initWheel();

        // 5. Êñ∞Â¢ûÔºöÂõûÂà∞Áî®Êà∂‰ΩçÁΩÆÊåâÈàï
        const backToUserBtn = document.createElement('button');
        backToUserBtn.className = 'back-to-user-btn';
        backToUserBtn.innerHTML = '<i class="fas fa-crosshairs"></i>';
        backToUserBtn.title = 'ÂõûÂà∞ÊàëÁöÑ‰ΩçÁΩÆ';
        backToUserBtn.addEventListener('click', centerOnUserLocation);
        document.querySelector('.main-content').appendChild(backToUserBtn);

        // 6. ÂàùÂßãÂåñÊêúÂ∞ãÂäüËÉΩ
        const searchInput = document.getElementById('searchInput');
        const searchBox = document.querySelector('.search-box');
        const searchToggle = document.querySelector('.search-toggle');
        const searchResults = document.getElementById('searchResults');

        // ÂàáÊèõÊêúÂ∞ãÊ¨ÑÈ°ØÁ§∫
        searchToggle.addEventListener('click', () => {
            searchBox.classList.toggle('active');
            if (searchBox.classList.contains('active')) {
                searchInput.focus();
            }
        });

        // ÈªûÊìäÂÖ∂‰ªñÂú∞ÊñπÊôÇÈö±ËóèÊêúÂ∞ãÊ¨Ñ
        document.addEventListener('click', (e) => {
            if (!searchBox.contains(e.target) && !searchToggle.contains(e.target)) {
                searchBox.classList.remove('active');
                searchResults.classList.remove('active');
            }
        });

        // Âü∑Ë°åÊêúÂ∞ãÁöÑÂáΩÊï∏
        const performSearch = () => {
            searchStores(searchInput.value, true, true);
        };

        // Êåâ‰∏ã Enter ÊôÇÊêúÂ∞ã
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Âç≥ÊôÇÊêúÂ∞ãÔºå‰∏çÈ°ØÁ§∫Êâæ‰∏çÂà∞ÁöÑÊèêÁ§∫Ôºå‰∏çÈÅ∏‰∏≠Á¨¨‰∏ÄÂÄã
        searchInput.addEventListener('input', (e) => {
            searchStores(e.target.value, false, false);
            if (e.target.value.trim() !== '') {
                searchResults.classList.add('active');
            } else {
                searchResults.classList.remove('active');
            }
        });

        // 7. ÂàùÂßãÂåñÊâìÂç°ÂäüËÉΩ
        initCheckIn();


        // 9. ËôïÁêÜÊâÄÊúâ URL ÂèÉÊï∏
        handleUrlParameters();

    } catch (error) {
        console.error('Error during initialization:', error);
        showToast('ËºâÂÖ•Â§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
    } finally {
        // Á¢∫‰øùÊâÄÊúâÂàùÂßãÂåñÂÆåÊàêÂæåÊâçÈö±Ëóè loading
        setTimeout(hideLoading, 500); // Ê∑ªÂä†Â∞èÂª∂ÈÅ≤‰ª•Á¢∫‰øùÂπ≥ÊªëÈÅéÊ∏°
    }
}

// Êñ∞Â¢ûÔºöÂàùÂßãÂåñÊâìÂç°ÂäüËÉΩ
function initCheckIn() {
    const checkInFab = document.getElementById('checkInFab');
    const checkInModal = document.getElementById('checkInModal');
    const closeModal = document.querySelector('.close-modal');
    const checkInForm = document.getElementById('checkInForm');
    const storeNameElement = document.getElementById('checkInStoreName');
    const storeAddressElement = document.getElementById('checkInStoreAddress');
    const ratingInput = document.getElementById('storeRating');
    const ratingStars = document.querySelectorAll('.rating-input i');
    const photoInput = document.getElementById('checkInPhoto');
    const photoPreview = document.getElementById('photoPreview');

    // ÊâìÂç°ÂäüËÉΩ‰∫ã‰ª∂Áõ£ËÅΩ
    checkInFab.addEventListener('click', () => {
        if (currentStore && canCheckIn()) {
            openCheckInModal(currentStore);
        }
    });

    closeModal.addEventListener('click', closeCheckInModal);

    checkInModal.addEventListener('click', (e) => {
        if (e.target === checkInModal) {
            closeCheckInModal();
        }
    });

    ratingStars.forEach(star => {
        star.addEventListener('click', handleRatingClick);
    });

    photoInput.addEventListener('change', handlePhotoPreview);

    checkInForm.addEventListener('submit', handleCheckInSubmit);
}

init();
